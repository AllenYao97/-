6. P2P应用
    6.1 纯P2P架构
      没有（或极少）一直运行的服务器
      任意端系统都可以直接通信
      利用peer的服务能力
      Peer节点间歇上网，每次IP地址都有可能变化

      例子：
        文件分发  （BitTorrent）
        流媒体    （KanKan）
        VoIP      （Skype）
    
    6.2 文件分发 C/S vs P2P
          问题：从一台服务器分发文件（大小F）到N个peer 需要多少时间
            Peer节点上下载能力是有限的资源
            Dc-s >= max{NF/Us，F/Dmin}               U:upload    D：download
             
            P2P模式：
              服务器传输：最少需要上载一份拷贝
                发送一个拷贝的时间：F/Us
              客户端：每个客户端必须下载一个拷贝
                最小下载带宽客户单耗时：F/Dmin
              客户端：所有客户端总体下载量NF
                最大上载带宽是 Us+U1+U2+....Un-1+Un
            Dp-p >= max{F/Us,F/Dmin,NF/(Us+sum(ui,i=[1,n]))}  
            
            总结：C/S模式传输时间随着用户N线性增加
                  P2P随着N的增加节约的时间越明显
            

    6.3 P2P管理
      非结构化P2P:
        peer-peer之间存在应用层上的逻辑关系（两个peer进行上载下载）：overlay 覆盖网
        overlay是任意的
        
        集中化目录：Napster
          当对等方连接时，告知中心服务器：IP地址，内容
          用户查询---->获得目录---->从XX用户处请求文件
        
        完全分布式：Gnutella
          全分布式：没有中心服务器
          开放文件共享协议
          许多Gnutella客户端实现了Gnutella协议
            类似HTTP由许多的浏览器
          覆盖网络：图
          如果X和Y之间有一个TCP连接，则两者之间存在一条边
          所有活动的对等方和边就是覆盖网络
          边并不是物理链路
          给定一个对等方，通常所连接的节点少于10个

          Gnutella协议  （类似广度优先搜索）
            在已有的TCP连接上发送查询报文
            对等方转发查询报文
            以反方向返回查询命中报文
            
            可拓展性：
              限制范围的 泛洪查询 flooding    ----> Ttl
              让中转的节点记住 已经查过这个问题了

            对等方加入：
              对等方X必须首先发现某些已经在覆盖网络中的其他对等方：使用可用对等方列表
                自己维持一张对等方列表（经常开机的对等方IP） ---->死党列表
                  如果这个表全没在线就GG了
                联系维持列表的Gnutella站点
              X接着试图与该列表上的对等方建立TCP连接，直到与某个对等方Y建立连接
              X向Y发送一个PING报文，Y转发该PING报文
              所有收到PING报文的对等方以Pong报文响应
                IP地址、共享文件的数量以及总字节数
              X收到许多Pong报文，然后他能建立其它TCP
            对等方离开：
              告诉对等方列表自己离开。
              对等方列表需要再找一个替代者来维持强度

        混合体:
          利用不匀称性：KaZaA
            每个对等方要么是一个组长，要么隶属于一个组长
              对等方与其组长之间有TCP连接
              组长对之间有TCP连接
            组长追踪其所有的孩子的内容
            组长与其它组长联系
              转发查询到其他组长
              获得其他组长的数据拷贝
            
            KaZaA:查询
              每个文件有一个散列标识码和一个描述符
                文件--->文件的描述----->文件的Hash 文件的Hash是文件的唯一标识       分布式命名的一种方式
                搜索匹配描述，匹配Hash
              客户端向其组长发送关键字查询
              组长用匹配进行响应：
                对每个匹配：元数据、散列标识码和IP地址
              如果组长将查询转发给其他组长，其他组长以匹配进行响应
              客户端选择要下载的文件
                向拥有文件的对等方发送一个带散列标识码的HTTP请求
        
        BT
              
      DHT (结构化) P2P:
        overlay是有序的（环状，树状...）

        哈希表
        DHT方案
        环形DHT 以及覆盖网络
        Peer波动

        优点：寻找文件更快速------>因为节点有序，资源也是有序分布（约定的），所需副本很少


    6.4 问题
      两大问题：
          如何定位所需资源：
          如何处理对等方的加入和离开
      可能的解决方案
          集中
            集中化目录存在的问题： 文件传输是分散的，而定位内容是高度集中的
              单点故障：目录服务器挂了，系统就崩了
              性能瓶颈：目录服务器压力太大了
                          1.用户多
                          2.处理用户上线下线，得确保资源定位的准确性
              侵犯版权：法不责众，但是目录服务器得背锅
          分散
          半分散

    
    6.5 P2P文件分发：BitTorrent
      文件被分为一个个块256KB
        一个表来维护这个文件的拥有情况  01010100101.....  0表示这一块无，1表示有   ----->bitmap 映射
      网络中的这些peers发送接收文件块，相互服务
        tracker:追踪torrent中参与节点
        Torrent（洪流）：节点的组，之间交换文件块

      Peer加入torrent：
        一开始没有块，但是将会通过其他节点处积累文件块 
          一开始任意获取，获取4块后，开始请求整个洪流中稀缺的块 稀缺优先
        向追踪服务器注册，获得peer节点列表，和部分peer节点构成邻居关系("连接")
        当peer下载时，该peer可以同时向其它节点提供上载服务
          优先服务服务过自己的对象
        Peer可能会变换用于交换块的peer节点
        扰动churn：peer节点可能会上线或者下线
        一旦一个peer拥有整个文件，他会（自私的）离开或者保留（利他注意）在torrent中

        总结：一开始没有块，任意下载4块，然后稀缺优先，因为下载了稀缺，更容易被请求，被请求越多，能被更多的向自己请求的节点服务，下载就越快  良性循环

      
      请求，发送文件块：
        请求块：稀缺优先
          在任何给定时间，不同peer节点拥有一个文件块的自己
          周期性的，Alice节点向邻居询问他们拥有哪些块的信息
          Alice向peer节点请求他希望的块，稀缺的块
        发送块：一报还一报 tit-for-tat
          Alice向4个peer发送块，这些块向它自己提供最大带宽的服务
            其它peer被Alice阻塞（将不会从Alice处获得服务）
            每10秒重新评估一次:前4位
          每个30秒：随机选择其它peer节点，向这个节点发送块
            优化疏通 这个节点
            新选择的节点可以加入这个top4

      BT网络如何加入洪流?
        BT网站有关于torrent文件的tracker server信息，检索的网站发起向tracker server发起加入请求，下载一丢丢后，随机丢给用户一些块和tracker server，让用户去跟tracker server下载

      
      




