5. 面向连接的传输:TCP

    
        5.1 TCP:概述

        点对点：
            一个发送方，一个接收方
        可靠的、按顺序的字节流：
            没有报文边界
        管道化（流水线）：
            TCP拥塞控制和流量控制设置窗口大小
        发送和接收缓存
        全双工数据：
            在同一连接中数据流双向流动
            MSS：最大报文段大小
                每一段报文都有TCP头部
                以太网MTU长度1500字节-->报文很长，必须打成一个个MSS大小+TCP头部---->到了IP层再加入IP头部，刚好一个MTU大小
                MSS=MTU-20-20=1460 Bytes TCP头部20字节，IP头部20字节
        面向连接：
            在数据交换之前，通过握手（交换控制报文）初始化发送方、接收方的状态变量
        有流量控制：
            发送方不会淹没接收方
![image](https://note.youdao.com/yws/res/b/WEBRESOURCEbd1b58fce80d319cc408c9b3aed941cb)
![image.png](https://note.youdao.com/yws/res/a/WEBRESOURCE7f835c304f45d2393e9c0fe5fcc4004a)
        
        5.2 TCP报文段结构
            
        序号：对字节计数，不是PDU计数
                报文段首字节在字节流的编号
                TCP:
                    head
                    body ----- mss第一个字节 所在整个字节流中的偏移量    
        确认号：对字节计数
                期望从另一方收到的下一个字节的序号
                累积确认
                例子：ACK=555, 说明已经收到554之前包括554的所有字节，期望发送555之后的内容与rdt的ACK不同（不需要-1）
                Q:接收方如何处理乱序的报文段-没有规定
                    可以缓存，可以抛弃。取决于实现者自己
        首部长度：4个字节为单位   保留位  标志位（用于两个进程之间的TCP连接）
        接收窗口：用于流量控制
        紧急数据指针：基本不用，十分古老的东西
![image.png](https://note.youdao.com/yws/res/2/WEBRESOURCEafe18cf8175efb503c497d6431a3cf22)
![image.png](https://note.youdao.com/yws/res/6/WEBRESOURCE9bab2e5aa65c854c97ac79dffb0d79e6)
        
        5.3 TCP往返延时(RTT)和超时
        
        Q：怎样设置TCP超时
            比RTT要长
                但是RTT是变化的
            太短：太早超时
                不必要的重传
            太长：对报文段的丢失反应太慢，消极
        Q：怎样预估RTT?
            SampleRTT:测量从报文段发出到收到的确认时间
                如果有重传，忽略此次测量
            SampleRTT会变化，因此估计的RTT应该比较平滑
                对几个最近的测量值求平均，而不是仅用当前的SampleRTT
![image.png](https://note.youdao.com/yws/res/e/WEBRESOURCE7b40ee58af57da463a31546a4a22afee)
![image.png](https://note.youdao.com/yws/res/1/WEBRESOURCEdb61d5e48af43fcab79270879bc9e3f1)

        5.4 TCP如何做RDT
            
        TCP在IP不可靠服务的基础上建立了rdt
            管道化的报文段
                GBN或SR
            累积确认（像GBN）
            单个重传定时器（像GBN）
            是否可以接收乱序，没有规范
        通过以下事件触发重传：
            超时：（只重发那个最早的未确认段：SR）
            重复的确认
                例子：收到了ACK50，之后又收到了3个ACK50，同时超时器还未超时---->因为3个重复触发重发，而非超时触发，又称为快速重传
                它假设跟在被确认的数据的后面的数据丢失了
                    第一个ACK是正常的
                    第二个ACK表示接收方收到的一个该段后的乱序段
                    第三四个ACK表示接收方收到2个，3个该段后的乱序段，则该段丢失的可能性非常大
        首先考虑简化的TCP发送方：
            忽略重复的确认
            忽略流量控制和拥塞控制
            
            建立连接后从初始化序号（InitialSeqNum）开始发送 ，初始化序号是双方建立连接时候就协商的
            一个从X，一个从Y开始发，而不是从固定序号开始
                防止老的连接上的段，被新的数据连接产生干扰
            NextSeqNum=NextSeqNum+length(data)------>发送窗口前沿移动
            
            TCP发送方事件：
                从应用层接收数据：
                    用nextseq创建报文段
                    序号nextseq位报文段首字节的字节流编号
                    如果定时器还没有运行，启动定时器
                        定时器与最早未确认的报文段关联
                        过期间隔TimeOutInterval
                    超时:
                        重传后沿最古老的报文段
                        重新启动定时器
                    收到确认：
                        如果是对尚未确认的报文段确认：
                            更新已被确认的报文序号
                            如果当前还有未被确认的报文段，重新启动定时器;如果没有，则关掉定时器
            
            产生TCP ACK的建议：
                接收方事件：
                    1.所期望序号的报文段按序到达，所有在期望序号之前的数据都已经被确认
                        -->TCP接收方动作：延迟的ACK。对领域给程序的报文段的到达最多等待500ms，如果下一个报文段在这个时间间隔内没有到达，则发送一个ACK
                            原因：减少ACK对发送方的干扰
                    2.有期望序号的报文段到达，另一个按序报文段等待发送ACK
                        -->TCP接收方动作：立即发送单个累积ACK，已确认两个按序报文段
                    3.比期望序号大的报文段乱序到达。检测出数据流中的间隔
                        -->TCP接收方动作：立即发送重复ACK，以指明下一个期待字节的序号
                            原因：赶紧让发送方别乱序了！
                    4.能部分或者完全填充接收数据间隔的报文段到达
                        -->TCP接收方动作：若该报文段起始于间隔（gap）的低端，则立即发送ACK
                    
                    事件12是关联的
![image.png](https://note.youdao.com/yws/res/6/WEBRESOURCEf8e5e652e93f0c102a92cb40c9f42906)
![image.png](https://note.youdao.com/yws/res/2/WEBRESOURCE6d839cf59a725ab542c0d02bc1be9052)
![image.png](https://note.youdao.com/yws/res/4/WEBRESOURCE2d1056bdf80cf0a615b920e490b95724)
        
        5.5 TCP流量控制
        
        接收方控制发送方，不让发送方发送的太多，太快，以至于让接收方的缓冲区溢出
        TCP报文段中有个接收窗口
            接收窗口：愿意接收的字节数（缓冲区余量）   receive window
        捎带技术：Piggybacking
        
        接收方在其向发送方的TCP段头部的rwnd字段"通告"其空闲buffer大小
            RcvBuffer大小通过socket选项设置（典型默认大小位4096字节）
            很多操作系统自动调整RcvBuffer
            发送方限制未确认（"in-flight"）字节的个数<=接收方发送过来的rwnd值
        
        目的：保证接收方不会被淹没
        
        缓存中的可用空间
            丢弃乱序的报文段（假设丢弃乱序）
                =RcvWindow
                =RcvBuffer-[LastByteRcvd - LastByteRead]
![image.png](https://note.youdao.com/yws/res/1/WEBRESOURCE481b757afbe65a8afd79c2c5b67bb411)

       5.6 TCP连接管理
       
       在正式交换数据之前，发送方和接收方握手建立通信关系：
        同意建立连接（每一方都知道对方愿意建立连接）
            2次握手（见图）
            Q:2次握手建立连接总是可行的吗？
                变化的延迟（连接请求的段没有丢，但可能超时）  连接请求段也有计时器
                    服务器可能维护很多虚假的 半连接 ，消耗了很多不必要的性能
                    已失效的连接请求报文段突然又传送到了服务端，因而产生错误
                由于丢失造成的重传(e.g. req_conn(x))
                报文乱序
                相互看不到对方
        同意连接参数(见图)
        
        2次握手造成半连接，已失效的连接请求报文段突然又传送到了服务端，因而产生错误都是表现。
        3次握手的必要性应该从3次握手的目的： 把IP的不可靠变成可靠 这个问题的本质是,信道不可靠,但是通信双发需要就某个问题达成一致.
        而要解决这个问题, 无论你在消息中包含什么信息,三次通信是理论上的最小值
        需要三次握手来约定确定双方的 ISN（初始 seq 序列号）。是最佳解决方案
        
![image.png](https://note.youdao.com/yws/res/5/WEBRESOURCE9d4e3c13e9ef281cc082ab85ad515ae5)
![image.png](https://note.youdao.com/yws/res/0/WEBRESOURCE99deacae4d1f583102435fdfcf202910)
![image.png](https://note.youdao.com/yws/res/d/WEBRESOURCEa64aced8075ce819bf90fd6a9fb14d7d)
![image.png](https://note.youdao.com/yws/res/f/WEBRESOURCEb28feb433d73643fb0f02a62a3a3417f)
![image.png](https://note.youdao.com/yws/res/1/WEBRESOURCE42deb137bca0410d6285fbdf73765081)

        5.7 TCP关闭连接
        
        客户端，服务器分别关闭他自己这一侧的连接
            发送Fin bit=1的TCP段
        一旦接收到FIN，用ACK回应
            接收到FIN段，ACK可以和它自己发出的FIN段一起发送
        可以处理同时的FIN交换
        
        两军问题：意味着TCP拆除并不完美
![image.png](https://note.youdao.com/yws/res/b/WEBRESOURCE4e47c24487b961c506f79e0778e8634b)